# use diskann to generate graph files
```bash
mkdir -p DiskANN/build/data && cd DiskANN/build/data
wget ftp://ftp.irisa.fr/local/texmex/corpus/sift.tar.gz
tar -xf sift.tar.gz
cd ..
./apps/utils/fvecs_to_bin float data/sift/sift_learn.fvecs data/sift/sift_learn.fbin
./apps/utils/fvecs_to_bin float data/sift/sift_query.fvecs data/sift/sift_query.fbin
``` 

```bash
./apps/utils/compute_groundtruth  --data_type float --dist_fn l2 --base_file data/sift/sift_learn.fbin --query_file  data/sift/sift_query.fbin --gt_file data/sift/sift_query_learn_gt100 --K 100
./apps/build_memory_index  --data_type float --dist_fn l2 --data_path data/sift/sift_learn.fbin --index_path_prefix data/sift/index_sift_learn_R32_L50_A1.2 -R 32 -L 50 --alpha 1.2
./apps/search_memory_index  --data_type float --dist_fn l2 --index_path_prefix data/sift/index_sift_learn_R32_L50_A1.2 --query_file data/sift/sift_query.fbin  --gt_file data/sift/sift_query_learn_gt100 -K 10 -L 10 20 30 40 50 100 --result_path data/sift/res
```

# custom flow
* build
  ```bash
  mkdir build
  cd build
  cmake ..
  make -j
  ```
* Pack Pages
  ```bash
  ./PackPages ../data/index_sift_learn_R32_L50_A1.2.data ../data/index_sift_learn_R32_L50_A1.2 ../data/index_sift_learn_R32_L50_A1.2_packed 
  ```
* Search Test 
  ```bash
  ./GraphSearch  ../data/index_sift_learn_R32_L50_A1.2.data ../data/index_sift_learn_R32_L50_A1.2 ../data/sift_query.fbin ../data/sift_query_learn_gt100 
  ```

# custom flow with reordering
* Generate METIS input
  ```bash
  ./Convert2METIS ../data/index_sift_learn_R32_L50_A1.2 ../data/index_sift_learn_R32_L50_A1.2_metis.graph
  ```
* run METIS - check partition number 4762 = ceil(100000/21)
  ```bash
  /storage1/hcho/ANN/mt-metis-0.7.2/build/Linux-x86_64/bin/mtmetis ../data/index_sift_learn_R32_L50_A1.2_metis.graph 4762 ../data/index_sift_learn_R32_L50_A1.2_metis.part
  ```

* reordering
  ```bash
  ./ReorderGraph ../data/index_sift_learn_R32_L50_A1.2.data ../data/index_sift_learn_R32_L50_A1.2 ../data/sift_query_learn_gt100 ../data/index_sift_learn_R32_L50_A1.2_metis.part _reordered  
  ```

* pack pages
  ```bash
  ./PackPages  ../data/index_sift_learn_R32_L50_A1.2.data_reordered ../data/index_sift_learn_R32_L50_A1.2_reordered ../data/index_sift_learn_R32_L50_A1.2_packed_reordered
  ```

* test 
  ```bash
  ./GraphSearchPacked -L 100 ../data/index_sift_learn_R32_L50_A1.2_packed_reordered  ../data/sift_query.fbin ../data/sift_query_learn_gt100_reordered 
  ```


# DiskANN flow with reordering
* DiskANN  
  ```bash
  ./apps/build_disk_index --data_type float --dist_fn l2 --data_path data/sift/sift_learn.fbin --index_path_prefix data/sift/disk_index_sift_learn_R32_L50_A1.2 -R 32 -L50 -B 0.003 -M 1
  ```
* Generate METIS input
  ```bash
  ./Convert2METISDiskANN ../data/disk_index_sift_learn_R32_L50_A1.2_disk.index ../data/index_sift_learn_R32_L50_A1.2_metis.graph
  ```
  
* run METIS - check partition number 196 = ceil(100000/512)
  ```bash
  /storage1/hcho/ANN/metis-5.1.0/build/Linux-x86_64/programs/gpmetis ../data/index_sift_learn_R32_L50_A1.2_metis.graph 196
  ```
* reordering
  ```bash
  ./ReorderGraphDiskANN ../data/disk_index_sift_learn_R32_L50_A1.2_pq_compressed.bin ../data/disk_index_sift_learn_R32_L50_A1.2_disk.index ../data/sift_query_learn_gt100 ../data/index_sift_learn_R32_L50_A1.2_metis.graph.part.196 _reordered  
  ```
* search test
  ```bash
  ./DiskANNSearch ../data/disk_index_sift_learn_R32_L50_A1.2_pq_pivots.bin ../data/disk_index_sift_learn_R32_L50_A1.2_pq_compressed.bin_reordered ../data/disk_index_sift_learn_R32_L50_A1.2_disk.index_reordered ../data/sift_query.fbin ../data/sift_query_learn_gt100_reordered 
  ```